- name: Setup Bastion Host with user and SSM
  hosts: bastion
  become: true
  vars:
    new_user: "user"
    public_key_path: "/tmp/devops.pub"  # 이건 미리 Ansible에서 파일 복사하거나 템플릿으로 바꿔도 됨
  tasks:

    - name: Update apt packages
      apt:
        update_cache: yes

    - name: Install snapd
      apt:
        name: snapd
        state: present

    - name: Install amazon-ssm-agent via snap
      community.general.snap:
        name: amazon-ssm-agent
        classic: yes

    - name: Enable and start amazon-ssm-agent
      shell: |
        snap start amazon-ssm-agent
      args:
        executable: /bin/bash

    - name: Create new user
      user:
        name: "{{ new_user }}"
        shell: /bin/bash
        create_home: yes

    - name: Create .ssh directory
      file:
        path: "/home/{{ new_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ new_user }}"
        group: "{{ new_user }}"

    - name: Copy public key to authorized_keys
      copy:
        src: "{{ public_key_path }}"
        dest: "/home/{{ new_user }}/.ssh/authorized_keys"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: '0600'
